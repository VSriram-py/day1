name: Sequential Output Workflow

on:
  push:
    branches: [ main ]
  pull_request:

jobs:

# ---------------- JOB 1 ----------------
  job1:
    name: Generate Build Metadata
    runs-on: ubuntu-latest

    outputs:
      build_id: ${{ steps.generate.outputs.build_id }}
      checksum: ${{ steps.generate.outputs.checksum }}

    steps:
      - uses: actions/checkout@v4

      - name: Install cowsay
        run: sudo apt-get update && sudo apt-get install -y cowsay

      - name: Simulate heavy computation (25s)
        run: |
          echo "Generating build metadata..."
          for i in {1..5}; do
            echo "Processing chunk $i..."
            sleep 1
          done

      - name: Generate outputs
        id: generate
        run: |
          BUILD_ID=$(date +%s)
          CHECKSUM=$(echo "$BUILD_ID-super-secret" | sha256sum | cut -d ' ' -f1)

          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT

      - name: Generate cowsay file
        run: |
          cowsay "Job1 Build ${{ steps.generate.outputs.build_id }}" > job1.txt

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: job1-artifact
          path: job1.txt


# ---------------- JOB 2 ----------------
  job2:
    name: Process Build Metadata
    runs-on: ubuntu-latest
    needs: job1

    outputs:
      artifact_tag: ${{ steps.process.outputs.artifact_tag }}

    steps:
      - name: Install cowsay
        run: sudo apt-get update && sudo apt-get install -y cowsay

      - name: Download job1 file
        uses: actions/download-artifact@v4
        with:
          name: job1-artifact

      - name: Simulate processing (25s)
        run: |
          echo "Received build id: ${{ needs.job1.outputs.build_id }}"
          echo "Validating checksum: ${{ needs.job1.outputs.checksum }}"
          for i in {1..5}; do
            echo "Validating part $i..."
            sleep 1
          done

      - name: Create artifact tag
        id: process
        run: |
          TAG="artifact-${{ needs.job1.outputs.build_id }}-$(echo ${{ needs.job1.outputs.checksum }} | cut -c1-8)"
          echo "artifact_tag=$TAG" >> $GITHUB_OUTPUT

      - name: Generate cowsay file (job2)
        run: |
          cowsay "Job2 Tag ${{ steps.process.outputs.artifact_tag }}" > job2.txt

      - name: Combine job1 + job2
        run: |
          cat job1.txt job2.txt > combined12.txt

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: combined-artifact
          path: combined12.txt


# ---------------- JOB 3 ----------------
  job3:
    name: Final Packaging
    runs-on: ubuntu-latest
    needs: [job1, job2]

    steps:
      - name: Install cowsay
        run: sudo apt-get update && sudo apt-get install -y cowsay

      - name: Download combined file
        uses: actions/download-artifact@v4
        with:
          name: combined-artifact

      - name: Simulate packaging (30s)
        run: |
          echo "Using Build ID: ${{ needs.job1.outputs.build_id }}"
          echo "Using Artifact Tag: ${{ needs.job2.outputs.artifact_tag }}"
          for i in {1..6}; do
            echo "Packaging layer $i..."
            sleep 1
          done

      - name: Generate cowsay file (job3)
        run: |
          cowsay "Final Package ${{ needs.job2.outputs.artifact_tag }}" > job3.txt

      - name: Merge final files
        run: |
          cat combined12.txt job3.txt > FINAL_PACKAGE.txt

      - name: Upload final result
        uses: actions/upload-artifact@v4
        with:
          name: final-package
          path: FINAL_PACKAGE.txt
